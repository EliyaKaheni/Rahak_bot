import csv
import telebot
from telebot import types

BOT_ID = '7047772089:AAGHg_wXHy4hj5BnzTbe2z1Ei_PkcTjts5g'
bot = telebot.TeleBot(BOT_ID)

# Users temp database
users = {}

# Leagues
Leagues = ['Ù„ÛŒÚ¯ 1', 'Ù„ÛŒÚ¯ 3', 'Ù„ÛŒÚ¯ 2']

# Error handler
def error(message):
    bot.send_message(message.chat.id, "Ø¨Ø¨Ø®Ø´ÛŒØ¯ ÙÚ©Ø± Ú©Ù†Ù… ÛŒÙ‡ Ø§Ø´ØªØ¨Ø§Ù‡ÛŒ Ù¾ÛŒØ´ Ø§ÙˆÙ…Ø¯Ù‡ ğŸ¤¦\n Ù„Ø·ÙØ§ Ø±Ø¨Ø§Øª Ø±Ùˆ Ù…Ø¬Ø¯Ø¯Ø§ Ø§Ø³ØªØ§Ø±Øª Ú©Ù† Ùˆ Ø§Ø² Ø§ÙˆÙ„ Ù…Ø±Ø§Ø­Ù„ Ø±Ùˆ Ø·ÛŒ Ú©Ù†. Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ù‡Ù… Ø¨Ø§ Ø§Ø¯Ù…ÛŒÙ† ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±.")


""" DATABASE MANAGEMENT """
def Read_DataBase():
    try:
        with open('users.csv', mode='r') as infile:
            reader = csv.reader(infile)
            temp = {rows[0]:[rows[1], rows[2], rows[3]] for rows in reader}

        print(temp)
        return temp
    except:
        print('Please check the database')

def Write_DataBase(users):
    try:
        field_names = ['ID', 'Name', 'Book', 'League']

        with open('users.csv', 'w') as csvfile:
            writer = csv.DictWriter(csvfile, fieldnames = field_names)
            writer.writeheader()
            writer.writerows(users)

    except:
        print('Please check the database')


""" MENUS """
def start_menu(message):
    try:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        item = types.KeyboardButton('Ø¨Ø±ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù†Ø§Ù… âœ…')
        markup.add(item)
        bot.send_message(message.chat.id, 'Ø¨Ø±ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù†Ø§Ù…ØŸ', reply_markup=markup)

    except:
        error(message)


def leagues_menu(message):
    try:
        markup = types.InlineKeyboardMarkup()

        for league in Leagues:
            glass_button = types.InlineKeyboardButton(
                text=league, callback_data=league)

            markup.add(glass_button)

        bot.send_message(
            message.chat.id, 'Ø§ÙØªØ®Ø§Ø± Ù‡Ù…Ø±Ø§Ù‡ÛŒØªÙˆÙ† ØªÙˆÛŒ Ú©Ø¯ÙˆÙ… Ù„ÛŒÚ¯ Ø±Ùˆ Ø¯Ø§Ø±ÛŒÙ…ØŸ', reply_markup=markup)

    except:
        error(message)


# Start handler
@bot.message_handler(commands=['start'])
def handle_start(message):
    try:
        # Saving the user
        global users
        users[message.chat.id] = {}

        #Setting the menu
        bot.send_message(message.chat.id, 'Ø³Ù„Ø§Ù… Ø¯ÙˆØ³Øª Ø¹Ø²ÛŒØ²Ø›\n\n Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø± ÙˆØ§Ø±Ø¯ Ø¨Ø§Øª Ø´Ø¯Ù‡ Ø§ÛŒØ¯. Ù„Ø·ÙØ§ Ù…Ø±Ø§Ø­Ù„ Ø«Ø¨Øª Ù†Ø§Ù… Ø±Ø§ Ø·ÛŒ Ú©Ù†ÛŒØ¯')
        start_menu(message)

    except:
        error(message)

# Sign-up section
@bot.message_handler(func=lambda message: message.text=='Ø¨Ø±ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù†Ø§Ù… âœ…')
def signup_1(message):
    try:
        bot.send_message(message.chat.id, 'Ù„Ø·ÙØ§ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯')
        bot.register_next_step_handler(message, signup_2)

    except:
        error(message)

def signup_2(message):
    try:
        global users
        name = message.text
        users[message.chat.id]['Name'] = name

        bot.send_message(message.chat.id, 'Ù„Ø·ÙØ§ Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ú©ØªØ§Ø¨ÛŒ Ú©Ù‡ Ù…ÛŒ Ø®ÙˆØ§Ù‡ÛŒØ¯ Ø¢Ù†Ø±Ø§ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ù†ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.')
        bot.register_next_step_handler(message, signup_3)

    except:
        error(message)

def signup_3(message):
    try:
        global users
        book = message.text
        users[message.chat.id]['Book'] = book

        bot.send_message(message.chat.id, 'Ù„Ø·ÙØ§ Ù„ÛŒÚ¯ÛŒ Ú©Ù‡ Ù…Ø§ÛŒÙ„ Ø¨Ù‡ Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ø¢Ù† Ù‡Ø³ØªÛŒØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.')
        leagues_menu(message)
    except:
        error(message)


@bot.callback_query_handler(func=lambda call: True)
def signup_4(call):
    try:
        global users

        if call.data in Leagues:
            bot.answer_callback_query(
                call.id, f'{call.data} :Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯')
            leagues = call.data
            users[call.message.chat.id]['League'] = leagues

        print(users)

    except:
        bot.send_message(call.message.chat.id, "Ø¨Ø¨Ø®Ø´ÛŒØ¯ ÙÚ©Ø± Ú©Ù†Ù… ÛŒÙ‡ Ø§Ø´ØªØ¨Ø§Ù‡ÛŒ Ù¾ÛŒØ´ Ø§ÙˆÙ…Ø¯Ù‡ ğŸ¤¦\n Ù„Ø·ÙØ§ Ø±Ø¨Ø§Øª Ø±Ùˆ Ù…Ø¬Ø¯Ø¯Ø§ Ø§Ø³ØªØ§Ø±Øª Ú©Ù† Ùˆ Ø§Ø² Ø§ÙˆÙ„ Ù…Ø±Ø§Ø­Ù„ Ø±Ùˆ Ø·ÛŒ Ú©Ù†. Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ù‡Ù… Ø¨Ø§ Ø§Ø¯Ù…ÛŒÙ† ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±.")


bot.polling()
