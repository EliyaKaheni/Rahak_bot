import os
import io
import ast
import kaleido
import telebot
import datetime
import pandas as pd
from telebot import types
import plotly.graph_objects as go
from persiantools.jdatetime import JalaliDate

BOT_ID = '7047772089:AAGHg_wXHy4hj5BnzTbe2z1Ei_PkcTjts5g'
bot = telebot.TeleBot(BOT_ID)

# Users temp database
cache = {}
users_cache = {}
mooshak_goal = 100
charkhak_goal = 100
admin_id = '128402264'

# Leagues
Leagues = ['Ù…ÙˆØ´Ú© ğŸš€', 'Ú†Ø±Ø®Ú© âš™ï¸']

# Error handler
def error(message):
    bot.send_message(message.chat.id, "Ø¨Ø¨Ø®Ø´ÛŒØ¯ ÙÚ©Ø± Ú©Ù†Ù… ÛŒÙ‡ Ø§Ø´ØªØ¨Ø§Ù‡ÛŒ Ù¾ÛŒØ´ Ø§ÙˆÙ…Ø¯Ù‡ ğŸ¤¦\n Ù„Ø·ÙØ§ Ø±Ø¨Ø§Øª Ø±Ùˆ Ù…Ø¬Ø¯Ø¯Ø§ Ø§Ø³ØªØ§Ø±Øª Ú©Ù† Ùˆ Ø§Ø² Ø§ÙˆÙ„ Ù…Ø±Ø§Ø­Ù„ Ø±Ùˆ Ø·ÛŒ Ú©Ù†. Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ù‡Ù… Ø¨Ø§ Ø§Ø¯Ù…ÛŒÙ† ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±.")


""" BASIC FUNCTIONS """
def my_progress_baby(l_sh, l):
    try:
      if len(l) == 0:
          return 0

      l = sorted(l, reverse=True)

      i = 0
      days = []

      while len(l) > i:
          year, month, day = map(int, l[0].split('-'))
          d = JalaliDate(year, month, day)

          if l_sh - d >= datetime.timedelta(1):
              break

          days.append(l[i])
          i+=1

      return days

    except Exception as e:
        print(f'Erorr in my_progress_baby {e}')

def last_shanbe(last_shanbeh):
    try:
      while(JalaliDate.weekday(last_shanbeh) != 0):
          last_shanbeh -= datetime.timedelta(1)

      return last_shanbeh

    except Exception as e:
      print(f'Error in last_shanbe : {e}')

def days_read(id, users, last_shanbeh):
    try:
      days = []
      users_reading = users['Books'].loc[users['ID']==id]
      for reading in users_reading:
        reading = eval(reading)
        for name, reading_list in reading.items():
          for date, pages in reading_list.items():
              year, month, day = map(int, date.split('-'))
              d = JalaliDate(year, month, day)

              if (last_shanbeh - d >= datetime.timedelta(1)) and (date not in days):
                  break

              days.append(date)

      return len(days)

    except Exception as e:
        print(f'Error in days_read : {e}')
        error(id)

def pages_read(id, users):
  try:
    last_shanbeh = last_shanbe(JalaliDate.today())
    users_reading = users['Books'].loc[users['ID']==id]
    pages_read_by_person = 0
    for reading in users_reading:
      reading = eval(reading)
      for name, reading_list in reading.items():
        for date, pages in reading_list.items():
            year, month, day = map(int, date.split('-'))
            d = JalaliDate(year, month, day)

            if last_shanbeh - d >= datetime.timedelta(1):
                break

            pages_read_by_person += pages

    return pages_read_by_person

  except Exception as e:
    print(f'Error in pages_read : {e}')
    error(id)

def league_pie(total, read):
  try:
    trace = go.Pie(values=[total - read, read], labels=['Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù†Ø´Ø¯Ù‡', 'Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯Ù‡'], marker={'colors': ['#A2C5DB', '#BBB19A']}, hole=0.5, textinfo='label')
    fig = go.FigureWidget(trace)

    image_bytes = fig.to_image(format='png')
    image_io = io.BytesIO(image_bytes)

    return image_io.getvalue()

  except Exception as e:
    print(f'Error in league_pie : {e}')

def leagues_situations(users, l):
  try:
    first = 0
    second = 0
    third = 0
    forth = 0

    for id in users['ID']:
      a = days_read(id, users, last_shanbe(JalaliDate.today()))
      if (a>=4 and l=='M') or (a>=1 and l=='C'):
        first += 1
      a = days_read(id, users, last_shanbe(JalaliDate.today()) - datetime.timedelta(7))
      if (a>=4 and l=='M') or (a>=1 and l=='C'):
        second += 1
      a = days_read(id, users, last_shanbe(JalaliDate.today()) - datetime.timedelta(14))
      if (a>=4 and l=='M') or (a>=1 and l=='C'):
        third += 1
      a = days_read(id, users, last_shanbe(JalaliDate.today()) - datetime.timedelta(21))
      if (a>=4 and l=='M') or (a>=1 and l=='C'):
        forth += 1

    return [(first), (second - first), (third - second), (forth - third)]

  except Exception as e:
    print(f'Error in leagues_situations : {e}')

def leagues_chart(charkhak, mooshak):
  try:
    df = pd.DataFrame({
        'Category': ['Ø³Ù‡ Ù‡ÙØªÙ‡ Ù‚Ø¨Ù„', 'Ø¯Ùˆ Ù‡ÙØªÙ‡ Ù‚Ø¨Ù„', 'Ù‡ÙØªÙ‡ Ù‚Ø¨Ù„', 'Ù‡ÙØªÙ‡ Ø¬Ø§Ø±ÛŒ'],
        'Charkhak': charkhak,
        'Mooshak': mooshak
    })

    fig = go.Figure()

    fig.add_trace(go.Bar(
        x=df['Category'],
        y=df['Charkhak'],
        name='Ù„ÛŒÚ¯ Ú†Ø±Ø®Ú©',
        marker_color='#A2C5DB'
    ))

    fig.add_trace(go.Bar(
        x=df['Category'],
        y=df['Mooshak'],
        name='Ù„ÛŒÚ¯ Ù…ÙˆØ´Ú©',
        marker_color='#758281'
    ))

    fig.add_trace(go.Scatter(
        x=df['Category'],
        y=df['Charkhak'],
        mode='lines+markers',
        name='Ù†Ù…ÙˆØ¯Ø§Ø± Ù¾ÛŒØ´Ø±ÙØª Ú†Ø±Ø®Ú©ÛŒ Ù‡Ø§',
        line=dict(color='darkblue')
    ))

    fig.add_trace(go.Scatter(
        x=df['Category'],
        y=df['Mooshak'],
        mode='lines+markers',
        name='Ù†Ù…ÙˆØ¯Ø§Ø± Ù¾ÛŒØ´Ø±ÙØª Ù…ÙˆØ´Ú©ÛŒ Ù‡Ø§',
        line=dict(color='darkgoldenrod')
    ))

    fig.update_layout(
        barmode='group',
        title='Ú¯Ø²Ø§Ø±Ø´ Ú†Ù‡Ø§Ø± Ù‡ÙØªÙ‡ ÛŒ Ø§Ø®ÛŒØ±',
        yaxis_title='ØªØ¹Ø¯Ø§Ø¯ Ø§ÙØ±Ø§Ø¯ Ù¾Ø§ÛŒØ¨Ù†Ø¯ Ø¨Ù‡ Ù‡Ø¯Ù'
    )

    image_bytes = fig.to_image(format='png')
    image_io = io.BytesIO(image_bytes)

    return image_io.getvalue()

  except Exception as e:
    print(f'Error in leagues_chart : {e}')

""" DATABASE MANAGEMENT """
def Read_DataBase(myfile):
    try:
        return pd.read_csv(f'{myfile}.csv')

    except:
        print('Please check the database, reading problem')

def Write_DataBase(users, myfile):
    try:
        users.drop(users.columns[users.columns.str.contains(
        'unnamed', case=False)], axis=1, inplace=True)
        users.to_csv(f'{myfile}.csv')

    except:
        print('Please check the database, writing problem')

def add_user_to_database(users_cache, id):
    try:
        if users_cache[id]['League'] == 'Ú†Ø±Ø®Ú© âš™ï¸':
            users = Read_DataBase('Charkhak')
        else:
            users = Read_DataBase('Mooshak')

        new_user = {'ID':id, 'Name':users_cache[id]['Name'],
        'Uni':users_cache[id]['Uni'], 'Field':users_cache[id]['Field'],
        'League':users_cache[id]['League'], 'Books':users_cache[id]['Book']}

        new_user_df = pd.DataFrame.from_dict(new_user)

        new_user_df.loc[0] = [id, users_cache[id]['Name'], users_cache[id]['Uni'],
        users_cache[id]['Field'], users_cache[id]['League'], users_cache[id]['Book']]

        users = pd.concat([users, new_user_df], ignore_index=True)
        users.reset_index()

        if users_cache[id]['League'] == 'Ú†Ø±Ø®Ú© âš™ï¸':
            Write_DataBase(users, 'Charkhak')
        else:
            Write_DataBase(users, 'Mooshak')

    except:
        print('Adding user failed.')

""" MENUS """

def start_menu(message):
    try:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        item = types.KeyboardButton('Ø¨Ø±ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù†Ø§Ù… âœ…')
        markup.add(item)
        bot.send_message(message.chat.id, 'Ø¨Ø±ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù†Ø§Ù…ØŸ', reply_markup=markup)

    except Exception as e:
        print(f'Error in start_menu: {e}')
        error(message)

def leagues_menu(message):
    try:
        markup = types.InlineKeyboardMarkup()

        for league in Leagues:
            glass_button = types.InlineKeyboardButton(
                text=league, callback_data=league)

            markup.add(glass_button)

        bot.send_message(
            message.chat.id, 'Ù„ÛŒÚ¯ØªÙˆÙ† Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒÙ†.', reply_markup=markup)

    except Exception as e:
        print(f'Error in leagues_menu: {e}')
        error(message)

def uni_menu(message):
    try:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        item1 = types.KeyboardButton('Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ Ø´Ø±ÛŒÙ')
        item2 = types.KeyboardButton('Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ ØªÙ‡Ø±Ø§Ù†')
        markup.add(item1, item2)
        bot.send_message(message.chat.id, 'Ù…Ø´ØºÙˆÙ„ Ø¨Ù‡ ØªØ­ØµÛŒÙ„ Ø¯Ø± Ú©Ø¯ÙˆÙ… Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ÛŒØ¯ØŸ', reply_markup=markup)

    except Exception as e:
        print(f'Error in uni_menu: {e}')
        error(message)

def date_menu(message):
    try:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)

        for i in range(0, 5):
            day = JalaliDate.today() - datetime.timedelta(i)
            item = types.KeyboardButton(str(day))
            markup.add(item)
        item_cancel = types.KeyboardButton('Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ')
        markup.add(item_cancel)
        bot.send_message(message.chat.id, 'Ù…Ø§ÛŒÙ„ Ø¨Ù‡ Ø«Ø¨Øª Ú©ØªØ§Ø¨Ø®ÙˆØ§Ù†ÛŒ Ø¯Ø± Ú†Ù‡ ØªØ§Ø±ÛŒØ®ÛŒ Ù‡Ø³ØªÛŒØ¯ØŸ', reply_markup=markup)

    except Exception as e:
        print(f'Error in date_menu: {e}')
        error(message)

def main_menu(message):
    try:
        global admin_id
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        item1 = types.KeyboardButton('Ø«Ø¨Øª Ù…Ø·Ø§Ù„Ø¹Ù‡')
        item2 = types.KeyboardButton('Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ù…Ø§Ø±')
        item3 = types.KeyboardButton('Ø­Ø°Ù Ú©ØªØ§Ø¨')
        item4 = types.KeyboardButton('Ø±Ù‡Ú© Ú†ÛŒØ³Øª')
        markup.add(item1, item2, item3, item4)

        if str(message.chat.id) == admin_id:
          item5 = types.KeyboardButton('ØªØ¹ÛŒÛŒÙ† Ù‡Ø¯Ù')
          item6 = types.KeyboardButton('Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¯ÛŒØªØ§ Ø¨ÛŒØ³')
          markup.add(item5, item6)

        bot.send_message(message.chat.id, 'Ø´Ù…Ø§ Ø¯Ø± Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±ÛŒØ¯', reply_markup=markup)
    except Exception as e:
        print(f'Error in main_menu: {e}')
        error(message)

def book_menu(message):
    try:
        users_charkhak = Read_DataBase('Charkhak')
        users_mooshak = Read_DataBase('Mooshak')

        users = None
        if message.chat.id in users_charkhak['ID'].values:
            users = users_charkhak
        elif message.chat.id in users_mooshak['ID'].values:
            users = users_mooshak
        else:
            bot.send_message(message.chat.id, "Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.")
            return

        if len(users.loc[users['ID'] == message.chat.id, 'Books'].values)!=0:
            user_books = eval(users.loc[users['ID'] == message.chat.id, 'Books'].values[0])
        else:
            user_books = {}

        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)

        for book in user_books.keys():
            item = types.KeyboardButton(book)
            markup.add(item)

        add_button = types.KeyboardButton('Ø§ÙØ²ÙˆØ¯Ù† Ú©ØªØ§Ø¨ Ø¬Ø¯ÛŒØ¯')
        markup.add(add_button)

        item_cancel = types.KeyboardButton('Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ')
        markup.add(item_cancel)

        bot.send_message(message.chat.id, 'Ú©ØªØ§Ø¨ÛŒ Ú©Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ø±Ø¯ÛŒÙ† Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒÙ†.', reply_markup=markup)

    except Exception as e:
        print(f'Error in book_menu: {e}')
        error(message)

def delete_book_menu(message):
    try:
      users_charkhak = Read_DataBase('Charkhak')
      users_mooshak = Read_DataBase('Mooshak')

      users = None
      if message.chat.id in users_charkhak['ID'].values:
          users = users_charkhak
      elif message.chat.id in users_mooshak['ID'].values:
          users = users_mooshak
      else:
          bot.send_message(message.chat.id, "Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.")
          return

      user_books_str = users.loc[users['ID'] == message.chat.id, 'Books'].values[0]

      if user_books_str:
          user_books = ast.literal_eval(user_books_str)
      else:
          user_books = {}

      markup = types.ReplyKeyboardMarkup(resize_keyboard=True)

      for book in user_books.keys():
          item = types.KeyboardButton(book)
          markup.add(item)

      cancel_button = types.KeyboardButton('Ù„ØºÙˆ')
      markup.add(cancel_button)

      bot.send_message(message.chat.id, 'Ú©ØªØ§Ø¨ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', reply_markup=markup)
      bot.register_next_step_handler(message, remove_book2)

    except Exception as e:
        print(f'Error in delete_book_menu: {e}')
        error(message)

def stats_menu(message):
    try:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        item1 = types.KeyboardButton('Ø¢Ù…Ø§Ø± Ù¾ÛŒØ´Ø±ÙØª Ø®ÙˆØ¯Ù…')
        item2 = types.KeyboardButton('Ø¢Ù…Ø§Ø± Ù¾ÛŒØ´Ø±ÙØª Ù„ÛŒÚ¯')
        item3 = types.KeyboardButton('Ù‡Ø¯Ù Ø¬Ù…Ø¹ÛŒ')
        item_cancel = types.KeyboardButton('Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ')
        markup.add(item1, item2, item3, item_cancel)

        bot.send_message(message.chat.id, 'Ø¯Ø± Ù…Ù†ÙˆÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ù…Ø§Ø± Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±ÛŒØ¯.', reply_markup=markup)
    except Exception as e:
        print(f'Error in stats_menu: {e}')
        error(message)

"""Sign-up Section"""
# Start handler
@bot.message_handler(commands=['start'])
def handle_start(message):
    try:
        global users_cache
        users_cache[message.chat.id] = {}

        bot.send_message(message.chat.id, 'Ø³Ù„Ø§Ù… :) \nØ¨Ù‡ Ø±Ù‡Ú© Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒÙ†. Ù„Ø·ÙØ§ Ù…Ø±Ø§Ø­Ù„ Ø«Ø¨Øª Ù†Ø§Ù… Ø±Ùˆ Ø·ÛŒ Ú©Ù†ÛŒÙ†.')

        start_menu(message)

    except Exception as e:
      print(f'Error in start: {e}')
      error(message)


# Sign-up section
@bot.message_handler(func=lambda message: message.text=='Ø¨Ø±ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù†Ø§Ù… âœ…')
def signup_1(message):
    try:
        bot.send_message(message.chat.id, 'Ù„Ø·ÙØ§ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ ØªÙˆÙ† Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯')
        bot.register_next_step_handler(message, signup_2)

    except Exception as e:
      print(f'Error in signup_1: {e}')
      error(message)


def signup_2(message):
    try:
        global users_cache
        name = message.text
        users_cache[message.chat.id]['Name'] = name

        uni_menu(message)
        bot.register_next_step_handler(message, signup_3)

    except Exception as e:
      print(f'Error in signup_2: {e}')
      error(message)


def signup_3(message):
    try:
        global users_cache
        university = message.text
        users_cache[message.chat.id]['Uni'] = university

        bot.send_message(message.chat.id, 'Ø±Ø´ØªÙ‡ ØªØ­ØµÛŒÙ„ÛŒØªÙˆÙ† Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯')
        bot.register_next_step_handler(message, signup_4)

    except Exception as e:
      print(f'Error in signup_3: {e}')
      error(message)


def signup_4(message):
    try:
        global users_cache
        field = message.text
        users_cache[message.chat.id]['Field'] = field

        bot.send_message(message.chat.id, 'Ú¯Ø±ÙˆÙ‡ Ú©ØªØ§Ø¨Ø®ÙˆØ§Ù†ÛŒ Ø±Ù‡Ú© Ø¯ÙˆØªØ§ Ù„ÛŒÚ¯ Ø¯Ø§Ø±Ù‡ Ú©Ù‡ Ø¨Ø§ Ù‡Ù… Ø¯Ø± Ù¾Ø§ÛŒØ¨Ù†Ø¯ Ø¨ÙˆØ¯Ù† Ø¨Ù‡ Ú©ØªØ§Ø¨Ø®ÙˆØ§Ù†ÛŒ Ø±Ù‚Ø§Ø¨Øª Ù…ÛŒÚ©Ù†Ù†. Ù„ÛŒÚ¯ Ù…ÙˆØ´Ú© Ùˆ Ù„ÛŒÚ¯ Ú†Ø±Ø®Ú©.\nÙ…ÙˆØ´Ú©ÛŒ Ù‡Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒÚ©Ù†Ù† Ú©Ù‡ Ø¯Ø± Ù‡ÙØªÙ‡ Ú†Ù‡Ø§Ø± Ø§Ù„ÛŒ Ù‡ÙØª Ø±ÙˆØ² Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù† Ùˆ Ú†Ø±Ø®Ú©ÛŒ Ù‡Ø§ ØªØµÙ…ÛŒÙ… Ø¯Ø§Ø±Ù† Ø¯Ø± Ù‡ÙØªÙ‡ ÛŒÚ© Ø§Ù„ÛŒ Ø³Ù‡ Ø±ÙˆØ² Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ù†Ù†Ø¯.')
        leagues_menu(message)

    except Exception as e:
      print(f'Error in signup_4: {e}')
      error(message)

@bot.callback_query_handler(func=lambda call: True)
def signup_5(call):
    try:
        global users_cache

        if call.data in Leagues:
            bot.answer_callback_query(
                call.id, f'{call.data} :Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯')
            leagues = call.data
            users_cache[call.message.chat.id]['League'] = leagues

        bot.send_message(call.message.chat.id, 'ØªØ¨Ø±ÛŒÚ© Ù…ÛŒÚ¯Ù… Ø´Ù…Ø§ Ø¯ÛŒÚ¯Ù‡ Ø¹Ø¶ÙˆÛŒ Ø§Ø² Ø±Ù‡Ú© Ù‡Ø³ØªÛŒØ¯. Ø¨Ù‡ ÛŒØ§Ø¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯ Ú©Ù‡ Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ù¾ÙˆÙ†Ø²Ø¯Ù‡ Ø±ÙˆØ² Ø¨Ø¯ÙˆÙ† Ø«Ø¨Øª Ù‡ÛŒÚ† Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø§ÛŒ Ø¯Ø± Ú¯Ø±ÙˆÙ‡ Ø¹Ø¶Ùˆ Ø¨Ø§Ø´ÛŒØ¯ØŒ Ø¹Ø¶ÙˆÛŒØª Ø´Ù…Ø§ Ù„ØºÙˆ Ù…ÛŒØ´Ù‡.')
        users_cache[call.message.chat.id]['Book'] = {}

        add_user_to_database(users_cache, call.message.chat.id)

        main_menu(call.message)

    except Exception as e:
      print(f'Error in signup_5: {e}')
      error(call.message)


"""Reading Section"""
@bot.message_handler(func=lambda message: message.text=='Ø«Ø¨Øª Ù…Ø·Ø§Ù„Ø¹Ù‡')
def date_set(message):
    try:
        date_menu(message)
        bot.register_next_step_handler(message, book_set)

    except Exception as e:
      print(f'Error in date_set: {e}')
      error(message)

def book_set(message):
    try:
      if message.text == 'Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ':
        main_menu(message)
        return
      global cache
      cache[message.chat.id] = []
      date = message.text
      cache[message.chat.id].append(date)

      book_menu(message)

      bot.register_next_step_handler(message, page_set)

    except Exception as e:
      print(f'Error in book_set: {e}')
      error(message)

def page_set(message):
    try:
        if message.text == 'Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ':
          main_menu(message)
          return

        global cache
        book_name = message.text
        if book_name != 'Ø§ÙØ²ÙˆØ¯Ù† Ú©ØªØ§Ø¨ Ø¬Ø¯ÛŒØ¯':
            cache[message.chat.id].append(book_name)

            bot.send_message(message.chat.id, 'Ú†Ù†Ø¯ ØµÙØ­Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ø±Ø¯Ù‡ Ø§ÛŒØ¯ØŸ')
            bot.register_next_step_handler(message, note_data)
        else:
            bot.send_message(message.chat.id, 'Ù†Ø§Ù… Ú©ØªØ§Ø¨ÛŒ Ú©Ù‡ Ù‚ØµØ¯ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¢Ù†Ø±Ø§ Ø¯Ø§Ø±ÛŒØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯')
            bot.register_next_step_handler(message, add_book1)

    except Exception as e:
      print(f'Error in page_set: {e}')
      error(message)

def add_book1(message):
    try:
        global cache
        book_name = message.text
        cache[message.chat.id].append(book_name)
        bot.send_message(message.chat.id, f'Ú©ØªØ§Ø¨ {book_name} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ù„ÛŒØ³Øª Ú©ØªØ§Ø¨Ù‡Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯. Ù„Ø·ÙØ§ ØªØ¹Ø¯Ø§Ø¯ ØµÙØ­Ù‡ Ø§ÛŒ Ø§Ø² Ø¢Ù† Ø±Ø§ Ú©Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ø±Ø¯Ù‡ Ø§ÛŒØ¯ØŒ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.')
        bot.register_next_step_handler(message, note_data)

    except Exception as e:
      print(f'Error in add_book_1: {e}')
      error(message)

def note_data(message):
    try:
        global cache
        id = int(message.chat.id)

        users_charkhak = Read_DataBase('Charkhak')
        users_mooshak = Read_DataBase('Mooshak')

        users = None
        if id in users_charkhak['ID'].values:
            League = 'C'
            users = users_charkhak
        elif id in users_mooshak['ID'].values:
            League = 'M'
            users = users_mooshak
        else:
            bot.send_message(message.chat.id, "Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.")
            return


        user_books_str = users.loc[users['ID'] == id, 'Books'].values[0]

        if user_books_str:
            user_books = ast.literal_eval(user_books_str)
        else:
            user_books = {}

        book_name = cache[id][1]
        pages_read = int(message.text)
        date_read = cache[id][0]

        if book_name not in user_books:
            user_books[book_name] = {}
            user_books[book_name][date_read] = pages_read
        else:
            user_books[book_name][date_read] += pages_read

        users.loc[users['ID'] == id, 'Books'] = str(user_books)

        if League == 'C':
            Write_DataBase(users, 'Charkhak')
        else:
            Write_DataBase(users, 'Mooshak')

        del cache[id]
        main_menu(message)

    except Exception as e:
        print(f'Error in note_data: {e}')
        error(message)

@bot.message_handler(func=lambda message: message.text=='Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ù…Ø§Ø±')
def statistics(message):
  stats_menu(message)


@bot.message_handler(func=lambda message: message.text=='Ø¢Ù…Ø§Ø± Ù¾ÛŒØ´Ø±ÙØª Ø®ÙˆØ¯Ù…')
def indivisual_progress(message):
    try:
      users_charkhak = Read_DataBase('Charkhak')
      users_mooshak = Read_DataBase('Mooshak')

      users = None
      if message.chat.id in users_charkhak['ID'].values:
          users = users_charkhak
      elif message.chat.id in users_mooshak['ID'].values:
          users = users_mooshak
      else:
          bot.send_message(message.chat.id, "Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.")
          return
      days = days_read(message.chat.id, users, last_shanbe(JalaliDate.today()))
      bot.send_message(message.chat.id, f'Ø´Ù…Ø§ Ø¯Ø± Ù‡ÙØªÙ‡ ØªØ§ Ú©Ù†ÙˆÙ† {days} Ø±ÙˆØ² Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ø±Ø¯Ù‡ Ø§ÛŒØ¯.')

    except Exception as e:
      print(f'Error in indivisual_progress: {e}')
      error(message)

@bot.message_handler(func=lambda message: message.text=='Ø¢Ù…Ø§Ø± Ù¾ÛŒØ´Ø±ÙØª Ù„ÛŒÚ¯')
def league_progress(message):
  try:
      users_charkhak = Read_DataBase('Charkhak')
      users_mooshak = Read_DataBase('Mooshak')

      charkhak_goods, mooshak_goods = leagues_situations(users_charkhak, 'C'), leagues_situations(users_mooshak, 'M')

      bot.send_message(message.chat.id, 'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¢Ù…Ø§Ø± Ù‡Ø³ØªÛŒÙ…ØŒ Ù„Ø·ÙØ§ Ú†Ù†Ø¯ Ù„Ø­Ø¸Ù‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ ...')

      bot.send_photo(message.chat.id, leagues_chart(charkhak_goods, mooshak_goods))


  except Exception as e:
      print(f'Error in league_progress: {e}')
      error(message)

@bot.message_handler(func=lambda message: message.text=='Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ')
def back_to_main_menu(message):
  try:
    main_menu(message)
  except Exception as e:
    print(f'Error in back_to_main_menu function: {e}')
    error(message)

@bot.message_handler(func=lambda message: message.text=='Ø­Ø°Ù Ú©ØªØ§Ø¨')
def remove_book1(message):
    delete_book_menu(message)

def remove_book2(message):
    try:
        book_to_delete = message.text
        if book_to_delete == 'Ù„ØºÙˆ':
            main_menu(message)
            return

        users_charkhak = Read_DataBase('Charkhak')
        users_mooshak = Read_DataBase('Mooshak')

        users = None
        if message.chat.id in users_charkhak['ID'].values:
            League = 'C'
            users = users_charkhak
        elif message.chat.id in users_mooshak['ID'].values:
            League = 'M'
            users = users_mooshak
        else:
            bot.send_message(message.chat.id, "Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.")
            return

        user_books_str = users.loc[users['ID'] == message.chat.id, 'Books'].values[0]

        if user_books_str:
            user_books = ast.literal_eval(user_books_str)
        else:
            bot.send_message(message.chat.id, "Ú©ØªØ§Ø¨ÛŒ Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù ÛŒØ§ÙØª Ù†Ø´Ø¯.")
            main_menu(message)
            return

        if book_to_delete in user_books:
            del user_books[book_to_delete]
            users.loc[users['ID'] == message.chat.id, 'Books'] = str(user_books)

            if League == 'C':
                Write_DataBase(users, 'Charkhak')
            else:
                Write_DataBase(users, 'Mooshak')

            bot.send_message(message.chat.id, f'Ú©ØªØ§Ø¨ {book_to_delete} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.')
        else:
            bot.send_message(message.chat.id, 'Ú©ØªØ§Ø¨ Ø¯Ø± Ù„ÛŒØ³Øª Ø´Ù…Ø§ ÛŒØ§ÙØª Ù†Ø´Ø¯.')

        main_menu(message)

    except Exception as e:
        print(f'Error in delete_book: {e}')
        error(message)

@bot.message_handler(func= lambda message: (message.text=='Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¯ÛŒØªØ§Ø¨ÛŒØ³' and message.chat.id == admin_id))
def database_download(message):
  try:
    users_charkhak = Read_DataBase('Charkhak')
    users_mooshak = Read_DataBase('Mooshak')

    users_charkhak.to_excel('Charkhak.xlsx')
    users_mooshak.to_excel('Mooshak.xlsx')

    with open('Charkhak.xlsx', 'rb') as file:
      bot.send_document(message.chat.id, file)
    with open('Mooshak.xlsx', 'rb') as file:
      bot.send_document(message.chat.id, file)

    os.remove('Mooshak.xlsx')
    os.remove('Charkhak.xlsx')

  except Exception as e:
        print(f'Error in database_download : {e}')
        error(message)


@bot.message_handler(func= lambda message: (message.text=='ØªØ¹ÛŒÛŒÙ† Ù‡Ø¯Ù' and message.chat.id == admin_id))
def goal_set_1(message):
  try:
    bot.send_message(message.chat.id, 'Ù‡Ø¯Ù Ú¯Ø±ÙˆÙ‡ Ú†Ø±Ø®Ú© Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯')
    bot.register_next_step_handler(message, goal_set_2)

  except Exception as e:
        print(f'Error in goal_set_1: {e}')
        error(message)

def goal_set_2(message):
  try:
    global charkhak_goal
    charkhak_goal = int(message.text)
    bot.send_message(message.chat.id, 'Ù‡Ø¯Ù Ú¯Ø±ÙˆÙ‡ Ù…ÙˆØ´Ú© Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯')
    bot.register_next_step_handler(message, goal_set_3)

  except Exception as e:
        print(f'Error in goal_set_2: {e}')
        error(message)

def goal_set_3(message):
  try:
    global mooshak_goal, charkhak_goal
    mooshak_goal = int(message.text)
    bot.send_message(message.chat.id, f'Ø§Ù‡Ø¯Ø§Ù Ø¬Ø¯ÛŒØ¯ ØªØ¹ÛŒÛŒÙ† Ø´Ø¯. {mooshak_goal} ØµÙØ­Ù‡ Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙˆÙ‡ Ù…ÙˆØ´Ú© Ùˆ {charkhak_goal} ØµÙØ­Ù‡ Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙˆÙ‡ Ú†Ø±Ø®Ú©.')
    main_menu(message)

  except Exception as e:
    print(f'Error in goal_set_3: {e}')
    error(message)

@bot.message_handler(func=lambda message: message.text=='Ù‡Ø¯Ù Ø¬Ù…Ø¹ÛŒ')
def league_goal_situation(message):
  try:
    global charkhak_goal, mooshak_goal

    users_charkhak = Read_DataBase('Charkhak')
    users_mooshak = Read_DataBase('Mooshak')

    users = None
    if message.chat.id in users_charkhak['ID'].values:
        League = 'C'
        users = users_charkhak
    elif message.chat.id in users_mooshak['ID'].values:
        League = 'M'
        users = users_mooshak
    else:
        bot.send_message(message.chat.id, "Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.")
        return

    all_group_progress = 0
    for id in users['ID']:
        all_group_progress += pages_read(id, users)

    if League == 'C':
        bot.send_message(message.chat.id, f'{all_group_progress} ØµÙØ­Ù‡ Ø§Ø² {charkhak_goal} ØµÙØ­Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª. ')
        bot.send_photo(message.chat.id, league_pie(charkhak_goal, all_group_progress))
    else:
        bot.send_message(message.chat.id, f'{all_group_progress} ØµÙØ­Ù‡ Ø§Ø² {mooshak_goal} ØµÙØ­Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª. ')
        bot.send_photo(message.chat.id, league_pie(mooshak_goal, all_group_progress))


  except Exception as e:
    print(f'Error in group_goal_situation: {e}')
    error(message)

bot.polling()
