import ast
import telebot
import datetime
from telebot import types
from persiantools.jdatetime import JalaliDate

BOT_ID = 'IWontTellYou'
bot = telebot.TeleBot(BOT_ID)

# Users temp database
users = {128402264: {'Name': 'Ø§ÛŒÙ„ÛŒØ§ Ú©Ø§Ù‡Ù†ÛŒ', 'Uni': 'Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ ØªÙ‡Ø±Ø§Ù†', 'Field': 'Ø¹Ù„ÙˆÙ… Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ±', 'League': 'Ú†Ø±Ø®Ú© âš™ï¸', 'Book':[]}}
cache = {}
users_cache = {}

# Reading class
class Reading:
    book_name = ''
    reading_dates = []
    page = 0

# Leagues
Leagues = ['Ù…ÙˆØ´Ú© ğŸš€', 'Ú†Ø±Ø®Ú© âš™ï¸']

# Error handler
def error(message):
    bot.send_message(message.chat.id, "Ø¨Ø¨Ø®Ø´ÛŒØ¯ ÙÚ©Ø± Ú©Ù†Ù… ÛŒÙ‡ Ø§Ø´ØªØ¨Ø§Ù‡ÛŒ Ù¾ÛŒØ´ Ø§ÙˆÙ…Ø¯Ù‡ ğŸ¤¦\n Ù„Ø·ÙØ§ Ø±Ø¨Ø§Øª Ø±Ùˆ Ù…Ø¬Ø¯Ø¯Ø§ Ø§Ø³ØªØ§Ø±Øª Ú©Ù† Ùˆ Ø§Ø² Ø§ÙˆÙ„ Ù…Ø±Ø§Ø­Ù„ Ø±Ùˆ Ø·ÛŒ Ú©Ù†. Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ù‡Ù… Ø¨Ø§ Ø§Ø¯Ù…ÛŒÙ† ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±.")


""" BASIC FUNCTIONS """
def been_before(s, l):
    loc = 0
    if len(l)==0:
        return -1
    for i in l:
        if i.name==s:
            return loc
        loc += 1
    return -1

def my_progress_baby(l_sh, l):
    try:
        if len(l) == 0:
            return 0

        l = sorted(l, reverse=True)

        i = 0
        days = []

        while len(l) > i:
            year, month, day = map(int, l[0].split('-'))
            d = JalaliDate(year, month, day)

            if l_sh - d >= datetime.timedelta(1):
                break

            days.append(l[i])
            i+=1

        return days

    except:
        print('Erorr in my_progress_baby function!')

def last_shanbe():
    try:
        last_shanbeh = JalaliDate.today()
        while(JalaliDate.weekday(last_shanbeh) != 0):
            last_shanbeh -= datetime.timedelta(1)

        return last_shanbeh

    except:
        print('Erorr in last_shanbe function!')

def my_progress(message):
    try:
        global users

        last_shanbeh = last_shanbe()
        days = []

        for book in users[message.chat.id]['Book']:
            l = book.reading_dates
            days = list(set(my_progress_baby(last_shanbeh, l)) | set(days))

        return len(days)

    except:
        error(message)

""" DATABASE MANAGEMENT """
def Read_DataBase(myfile):
    # try:
    with open(f'{myfile}.txt', mode='r') as file:
        content = file.read().strip()
        return ast.literal_eval(content)
    # except:
    #     print('Please check the database, reading problem')

def Write_DataBase(users, myfile):
    try:
        with open(f'{myfile}.txt', mode='w') as file:
            file.write(str(users))

    except:
        print('Please check the database, writing problem')

def add_user_to_database(users_cache, id):
    if users_cache[id]['League'] == 'Ú†Ø±Ø®Ú© âš™ï¸':
        users = Read_DataBase('Charkhak')
    else:
        users = Read_DataBase('Mooshak')

    users[id]['Name'] = users_cache[id]['Name']
    users[id]['Uni'] = users_cache[id]['Uni']
    users[id]['Field'] = users_cache[id]['Field']
    users[id]['League'] = users_cache[id]['League']
    users[id]['Book'] = users_cache[id]['Book']

    if users_cache[id]['League'] == 'Ú†Ø±Ø®Ú© âš™ï¸':
        Write_DataBase(users, 'Charkhak')
    else:
        Write_DataBase(users, 'Mooshak')

""" MENUS """

def start_menu(message):
    try:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        item = types.KeyboardButton('Ø¨Ø±ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù†Ø§Ù… âœ…')
        markup.add(item)
        bot.send_message(message.chat.id, 'Ø¨Ø±ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù†Ø§Ù…ØŸ', reply_markup=markup)

    except:
        error(message)

def leagues_menu(message):
    try:
        markup = types.InlineKeyboardMarkup()

        for league in Leagues:
            glass_button = types.InlineKeyboardButton(
                text=league, callback_data=league)

            markup.add(glass_button)

        bot.send_message(
            message.chat.id, 'Ù„ÛŒÚ¯ØªÙˆÙ† Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒÙ†.', reply_markup=markup)

    except:
        error(message)

def uni_menu(message):
    try:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        item1 = types.KeyboardButton('Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ Ø´Ø±ÛŒÙ')
        item2 = types.KeyboardButton('Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ ØªÙ‡Ø±Ø§Ù†')
        markup.add(item1, item2)
        bot.send_message(message.chat.id, 'Ù…Ø´ØºÙˆÙ„ Ø¨Ù‡ ØªØ­ØµÛŒÙ„ Ø¯Ø± Ú©Ø¯ÙˆÙ… Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ÛŒØ¯ØŸ', reply_markup=markup)

    except:
        error(message)

def date_menu(message):
    try:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)

        for i in range(0, 5):
            day = JalaliDate.today() - datetime.timedelta(i)
            item = types.KeyboardButton(str(day))
            markup.add(item)

        bot.send_message(message.chat.id, 'Ù…Ø§ÛŒÙ„ Ø¨Ù‡ Ø«Ø¨Øª Ú©ØªØ§Ø¨Ø®ÙˆØ§Ù†ÛŒ Ø¯Ø± Ú†Ù‡ ØªØ§Ø±ÛŒØ®ÛŒ Ù‡Ø³ØªÛŒØ¯ØŸ', reply_markup=markup)

    except:
        error(message)

def main_menu(message):
    try:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        item1 = types.KeyboardButton('Ø«Ø¨Øª Ù…Ø·Ø§Ù„Ø¹Ù‡')
        item2 = types.KeyboardButton('Ø¬Ù…Ø¹ Ø¢Ù…Ø§Ø± Ø®ÙˆØ¯Ù…')
        item3 = types.KeyboardButton('Ø­Ø°Ù Ú©ØªØ§Ø¨')
        markup.add(item1, item2, item3)

        bot.send_message(message.chat.id, 'Ø´Ù…Ø§ Ø¯Ø± Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±ÛŒØ¯', reply_markup=markup)
    except:
        error(message)

def book_menu(message):
    try:
        global users
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)

        if users[message.chat.id]['Book']:
            for book in users[message.chat.id]['Book']:
                item = types.KeyboardButton(book.name)
                markup.add(item)

        add_button = types.KeyboardButton('Ø§ÙØ²ÙˆØ¯Ù† Ú©ØªØ§Ø¨ Ø¬Ø¯ÛŒØ¯')
        markup.add(add_button)

        bot.send_message(
            message.chat.id, 'Ú©ØªØ§Ø¨ÛŒ Ú©Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ø±Ø¯ÛŒÙ† Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒÙ†.', reply_markup=markup)

    except:
        error(message)


"""Sign-up Section"""
# Start handler
@bot.message_handler(commands=['start'])
def handle_start(message):
    try:
        # Saving the user
        global users_cache
        users_cache[message.chat.id] = {}

        #Setting the menu
        bot.send_message(message.chat.id, 'Ø³Ù„Ø§Ù… :) \nØ¨Ù‡ Ø±Ù‡Ú© Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒÙ†. Ù„Ø·ÙØ§ Ù…Ø±Ø§Ø­Ù„ Ø«Ø¨Øª Ù†Ø§Ù… Ø±Ùˆ Ø·ÛŒ Ú©Ù†ÛŒÙ†.')

        start_menu(message)

    except:
        error(message)

# Sign-up section
@bot.message_handler(func=lambda message: message.text=='Ø¨Ø±ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù†Ø§Ù… âœ…')
def signup_1(message):
    try:
        bot.send_message(message.chat.id, 'Ù„Ø·ÙØ§ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ ØªÙˆÙ† Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯')
        bot.register_next_step_handler(message, signup_2)

    except:
        error(message)

def signup_2(message):
    try:
        global users_cache
        name = message.text
        users_cache[message.chat.id]['Name'] = name

        uni_menu(message)
        bot.register_next_step_handler(message, signup_3)

    except:
        error(message)

def signup_3(message):
    try:
        global users_cache
        university = message.text
        users_cache[message.chat.id]['Uni'] = university

        bot.send_message(message.chat.id, 'Ø±Ø´ØªÙ‡ ØªØ­ØµÛŒÙ„ÛŒØªÙˆÙ† Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯')
        bot.register_next_step_handler(message, signup_4)

    except:
        error(message)

def signup_4(message):
    try:
        global users_cache
        field = message.text
        users_cache[message.chat.id]['Field'] = field

        bot.send_message(message.chat.id, 'Ú¯Ø±ÙˆÙ‡ Ú©ØªØ§Ø¨Ø®ÙˆØ§Ù†ÛŒ Ø±Ù‡Ú© Ø¯ÙˆØªØ§ Ù„ÛŒÚ¯ Ø¯Ø§Ø±Ù‡ Ú©Ù‡ Ø¨Ø§ Ù‡Ù… Ø¯Ø± Ù¾Ø§ÛŒØ¨Ù†Ø¯ Ø¨ÙˆØ¯Ù† Ø¨Ù‡ Ú©ØªØ§Ø¨Ø®ÙˆØ§Ù†ÛŒ Ø±Ù‚Ø§Ø¨Øª Ù…ÛŒÚ©Ù†Ù†. Ù„ÛŒÚ¯ Ù…ÙˆØ´Ú© Ùˆ Ù„ÛŒÚ¯ Ú†Ø±Ø®Ú©.\nÙ…ÙˆØ´Ú©ÛŒ Ù‡Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒÚ©Ù†Ù† Ú©Ù‡ Ø¯Ø± Ù‡ÙØªÙ‡ Ú†Ù‡Ø§Ø± Ø§Ù„ÛŒ Ù‡ÙØª Ø±ÙˆØ² Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù† Ùˆ Ú†Ø±Ø®Ú©ÛŒ Ù‡Ø§ ØªØµÙ…ÛŒÙ… Ø¯Ø§Ø±Ù† Ø¯Ø± Ù‡ÙØªÙ‡ ÛŒÚ© Ø§Ù„ÛŒ Ø³Ù‡ Ø±ÙˆØ² Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ù†Ù†Ø¯.')
        leagues_menu(message)
    except:
        error(message)

@bot.callback_query_handler(func=lambda call: True)
def signup_5(call):
    try:
        global users_cache

        if call.data in Leagues:
            bot.answer_callback_query(
                call.id, f'{call.data} :Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯')
            leagues = call.data
            users_cache[call.message.chat.id]['League'] = leagues

        bot.send_message(call.message.chat.id, 'ØªØ¨Ø±ÛŒÚ© Ù…ÛŒÚ¯Ù… Ø´Ù…Ø§ Ø¯ÛŒÚ¯Ù‡ Ø¹Ø¶ÙˆÛŒ Ø§Ø² Ø±Ù‡Ú© Ù‡Ø³ØªÛŒØ¯. Ø¨Ù‡ ÛŒØ§Ø¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯ Ú©Ù‡ Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ù¾ÙˆÙ†Ø²Ø¯Ù‡ Ø±ÙˆØ² Ø¨Ø¯ÙˆÙ† Ø«Ø¨Øª Ù‡ÛŒÚ† Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø§ÛŒ Ø¯Ø± Ú¯Ø±ÙˆÙ‡ Ø¹Ø¶Ùˆ Ø¨Ø§Ø´ÛŒØ¯ØŒ Ø¹Ø¶ÙˆÛŒØª Ø´Ù…Ø§ Ù„ØºÙˆ Ù…ÛŒØ´Ù‡.')
        users_cache[call.message.chat.id]['Book'] = []

        add_user_to_database(users_cache, call.message.chat.id)

        main_menu(call.message)

    except:
        error(call.message)


"""Reading Section"""
@bot.message_handler(func=lambda message: message.text=='Ø«Ø¨Øª Ù…Ø·Ø§Ù„Ø¹Ù‡')
def date_set(message):
    try:
        date_menu(message)
        bot.register_next_step_handler(message, book_set)

    except:
        error(message)

def book_set(message):
    try:
        global cache
        cache[message.chat.id] = []
        date = message.text
        cache[message.chat.id].append(date)

        book_menu(message)

        bot.register_next_step_handler(message, page_set)

    except:
        error(message)

def page_set(message):
    try:
        global cache
        book_name = message.text
        if book_name != 'Ø§ÙØ²ÙˆØ¯Ù† Ú©ØªØ§Ø¨ Ø¬Ø¯ÛŒØ¯':
            cache[message.chat.id].append(book_name)

            bot.send_message(message.chat.id, 'Ú†Ù†Ø¯ ØµÙØ­Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ø±Ø¯Ù‡ Ø§ÛŒØ¯ØŸ')
            bot.register_next_step_handler(message, note_data)
        else:
            bot.send_message(message.chat.id, 'Ù†Ø§Ù… Ú©ØªØ§Ø¨ÛŒ Ú©Ù‡ Ù‚ØµØ¯ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¢Ù†Ø±Ø§ Ø¯Ø§Ø±ÛŒØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯')
            bot.register_next_step_handler(message, add_book1)

    except:
        error(message)

def add_book1(message):
    try:
        global cache
        book_name = message.text
        cache[message.chat.id].append(book_name)
        bot.send_message(message.chat.id, f'Ú©ØªØ§Ø¨ {book_name} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ù„ÛŒØ³Øª Ú©ØªØ§Ø¨Ù‡Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯. Ù„Ø·ÙØ§ ØªØ¹Ø¯Ø§Ø¯ ØµÙØ­Ù‡ Ø§ÛŒ Ø§Ø² Ø¢Ù† Ø±Ø§ Ú©Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ø±Ø¯Ù‡ Ø§ÛŒØ¯ØŒ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.')
        bot.register_next_step_handler(message, note_data)

    except:
        error(message)

def note_data(message):
    # try:
    global cache

    users_charkhak = Read_DataBase('Charkhak')
    users_mooshak = Read_DataBase('Mooshak')
    users = {}
    if message.chat.id in users_charkhak.keys():
        users = users_charkhak
    else:
        users = users_mooshak

    print(users)

    loc = been_before(cache[message.chat.id][1], users[message.chat.id]['Book'])

    if loc == -1:
        temp = Reading()
        temp.reading_dates.append(cache[message.chat.id][0])
        temp.name = cache[message.chat.id][1]
        temp.page += int(message.text)

        users[message.chat.id]['Book'].append(temp)
        del cache[message.chat.id]

    else:
        users[message.chat.id]['Book'][loc].page += int(message.text)
        users[message.chat.id]['Book'][loc].reading_dates.append(cache[message.chat.id][0])

    if users[message.chat.id]['League'] == 'Ú†Ø±Ø®Ú© âš™ï¸':
        Write_DataBase(users, 'Charkhak')
    else:
        Write_DataBase(users, 'Mooshak')

    main_menu(message)

    # except:
    #     error(message)

@bot.message_handler(func=lambda message: message.text=='Ø¬Ù…Ø¹ Ø¢Ù…Ø§Ø± Ø®ÙˆØ¯Ù…')
def indivisual_progress(message):
    global users

    days = my_progress(message)
    bot.send_message(message.chat.id, f'Ø´Ù…Ø§ Ø¯Ø± Ù‡ÙØªÙ‡ ØªØ§ Ú©Ù†ÙˆÙ† {days} Ø±ÙˆØ² Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ø±Ø¯Ù‡ Ø§ÛŒØ¯.')

@bot.message_handler(func=lambda message: message.text=='Ø­Ø°Ù Ú©ØªØ§Ø¨')
def remove_book1(message):
    pass

bot.polling()
