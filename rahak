import csv
import telebot
from telebot import types

BOT_ID = '7047772089:AAGHg_wXHy4hj5BnzTbe2z1Ei_PkcTjts5g'
bot = telebot.TeleBot(BOT_ID)

# Users temp database
users = {}

# Leagues
Leagues = ['لیگ 1', 'لیگ 3', 'لیگ 2']

# Error handler
def error(message):
    bot.send_message(message.chat.id, "ببخشید فکر کنم یه اشتباهی پیش اومده 🤦\n لطفا ربات رو مجددا استارت کن و از اول مراحل رو طی کن. در صورت نیاز هم با ادمین تماس بگیر.")


""" DATABASE MANAGEMENT """
def Read_DataBase():
    try:
        with open('users.csv', mode='r') as infile:
            reader = csv.reader(infile)
            temp = {rows[0]:[rows[1], rows[2], rows[3]] for rows in reader}

        print(temp)
        return temp
    except:
        print('Please check the database')

def Write_DataBase(users):
    try:
        field_names = ['ID', 'Name', 'Book', 'League']

        with open('users.csv', 'w') as csvfile:
            writer = csv.DictWriter(csvfile, fieldnames = field_names)
            writer.writeheader()
            writer.writerows(users)

    except:
        print('Please check the database')


""" MENUS """
def start_menu(message):
    try:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        item = types.KeyboardButton('بریم برای ثبت نام ✅')
        markup.add(item)
        bot.send_message(message.chat.id, 'بریم برای ثبت نام؟', reply_markup=markup)

    except:
        error(message)


def leagues_menu(message):
    try:
        markup = types.InlineKeyboardMarkup()

        for league in Leagues:
            glass_button = types.InlineKeyboardButton(
                text=league, callback_data=league)

            markup.add(glass_button)

        bot.send_message(
            message.chat.id, 'افتخار همراهیتون توی کدوم لیگ رو داریم؟', reply_markup=markup)

    except:
        error(message)


# Start handler
@bot.message_handler(commands=['start'])
def handle_start(message):
    try:
        # Saving the user
        global users
        users[message.chat.id] = {}

        #Setting the menu
        bot.send_message(message.chat.id, 'سلام دوست عزیز؛\n\n شما برای اولین بار وارد بات شده اید. لطفا مراحل ثبت نام را طی کنید')
        start_menu(message)

    except:
        error(message)

# Sign-up section
@bot.message_handler(func=lambda message: message.text=='بریم برای ثبت نام ✅')
def signup_1(message):
    try:
        bot.send_message(message.chat.id, 'لطفا نام خود را وارد کنید')
        bot.register_next_step_handler(message, signup_2)

    except:
        error(message)

def signup_2(message):
    try:
        global users
        name = message.text
        users[message.chat.id]['Name'] = name

        bot.send_message(message.chat.id, 'لطفا نام کامل کتابی که می خواهید آنرا مطالعه کنید را وارد کنید.')
        bot.register_next_step_handler(message, signup_3)

    except:
        error(message)

def signup_3(message):
    try:
        global users
        book = message.text
        users[message.chat.id]['Book'] = book

        bot.send_message(message.chat.id, 'لطفا لیگی که مایل به عضویت در آن هستید را انتخاب کنید.')
        leagues_menu(message)
    except:
        error(message)


@bot.callback_query_handler(func=lambda call: True)
def signup_4(call):
    try:
        global users

        if call.data in Leagues:
            bot.answer_callback_query(
                call.id, f'{call.data} :انتخاب شد')
            leagues = call.data
            users[call.message.chat.id]['League'] = leagues

        print(users)

    except:
        bot.send_message(call.message.chat.id, "ببخشید فکر کنم یه اشتباهی پیش اومده 🤦\n لطفا ربات رو مجددا استارت کن و از اول مراحل رو طی کن. در صورت نیاز هم با ادمین تماس بگیر.")


bot.polling()
